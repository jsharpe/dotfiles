#!/bin/bash

set -e

echo "==> Installing packages for Linux..."

# Detect if cargo is available
if ! command -v cargo &> /dev/null; then
    echo "==> Installing Rust/Cargo..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
fi

# Install fzf
if ! command -v fzf &> /dev/null; then
    echo "==> Installing fzf..."
    if [ -d ~/.fzf ]; then
        echo "==> fzf directory exists, running installer..."
        ~/.fzf/install --bin --key-bindings --completion --no-update-rc
    else
        git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
        ~/.fzf/install --bin --key-bindings --completion --no-update-rc
    fi
else
    echo "==> fzf is already installed ($(fzf --version))"
fi

# Install zoxide
if ! command -v zoxide &> /dev/null; then
    echo "==> Installing zoxide..."
    curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh
else
    echo "==> zoxide is already installed ($(zoxide --version))"
fi

# Install starship
if ! command -v starship &> /dev/null; then
    echo "==> Installing starship..."
    curl -sS https://starship.rs/install.sh | sh -s -- -y
else
    echo "==> starship is already installed ($(starship --version))"
fi

# Install jj (Jujutsu VCS)
if ! command -v jj &> /dev/null; then
    echo "==> Installing jj (Jujutsu VCS) via cargo..."
    cargo install --locked jj-cli
else
    echo "==> jj is already installed ($(jj --version))"
fi

# Install neovim
if ! command -v nvim &> /dev/null; then
    echo "==> Installing neovim..."
    ARCH=$(uname -m)
    if [ "$ARCH" = "x86_64" ]; then
        NVIM_ARCH="x86_64"
    elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
        NVIM_ARCH="arm64"
    else
        echo "==> Unsupported architecture: $ARCH"
        exit 1
    fi

    NVIM_FILE="nvim-linux-${NVIM_ARCH}.tar.gz"
    NVIM_DIR="nvim-linux-${NVIM_ARCH}"
    rm -f "$NVIM_FILE"
    curl -fLO "https://github.com/neovim/neovim/releases/latest/download/${NVIM_FILE}"
    sudo rm -rf "/opt/${NVIM_DIR}"
    sudo tar -C /opt -xzf "$NVIM_FILE"
    rm "$NVIM_FILE"
    sudo ln -sf "/opt/${NVIM_DIR}/bin/nvim" /usr/local/bin/nvim
else
    echo "==> neovim is already installed ($(nvim --version | head -n1))"
fi

# Install gh CLI
if ! command -v gh &> /dev/null; then
    echo "==> Installing gh CLI..."
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
    sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
    sudo apt update
    sudo apt install gh -y
else
    echo "==> gh is already installed ($(gh --version | head -n1))"
fi

# Install bat
if ! command -v bat &> /dev/null; then
    echo "==> Installing bat..."
    cargo install --locked bat
else
    echo "==> bat is already installed ($(bat --version))"
fi

# Install eza
if ! command -v eza &> /dev/null; then
    echo "==> Installing eza..."
    cargo install --locked eza
else
    echo "==> eza is already installed ($(eza --version | head -n1))"
fi

# Install ripgrep
if ! command -v rg &> /dev/null; then
    echo "==> Installing ripgrep..."
    cargo install --locked ripgrep
else
    echo "==> ripgrep is already installed ($(rg --version | head -n1))"
fi

# Install fd
if ! command -v fd &> /dev/null; then
    echo "==> Installing fd..."
    cargo install --locked fd-find
else
    echo "==> fd is already installed ($(fd --version))"
fi

# Install jq
if ! command -v jq &> /dev/null; then
    echo "==> Installing jq..."
    sudo apt update
    sudo apt install jq -y
else
    echo "==> jq is already installed ($(jq --version))"
fi

# Install tokei
if ! command -v tokei &> /dev/null; then
    echo "==> Installing tokei..."
    cargo install --locked tokei
else
    echo "==> tokei is already installed ($(tokei --version))"
fi

# Install duf
if ! command -v duf &> /dev/null; then
    echo "==> Installing duf..."
    cargo install --locked duf
else
    echo "==> duf is already installed ($(duf --version | head -n1))"
fi

# Install dust
if ! command -v dust &> /dev/null; then
    echo "==> Installing dust..."
    cargo install --locked du-dust
else
    echo "==> dust is already installed ($(dust --version))"
fi

echo "==> Linux package installation complete!"
