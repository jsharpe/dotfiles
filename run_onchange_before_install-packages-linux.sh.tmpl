#!/bin/bash

set -e

echo "==> Installing packages for Linux..."

# Detect if cargo is available
if ! command -v cargo &> /dev/null; then
    echo "==> Installing Rust/Cargo..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
fi

# Install fzf
if ! command -v fzf &> /dev/null; then
    echo "==> Installing fzf..."
    git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
    ~/.fzf/install --all --no-bash --no-zsh
else
    echo "==> fzf is already installed ($(fzf --version))"
fi

# Install starship
if ! command -v starship &> /dev/null; then
    echo "==> Installing starship..."
    curl -sS https://starship.rs/install.sh | sh -s -- -y
else
    echo "==> starship is already installed ($(starship --version))"
fi

# Install jj (Jujutsu VCS)
if ! command -v jj &> /dev/null; then
    echo "==> Installing jj (Jujutsu VCS) via cargo..."
    cargo install --locked jj-cli
else
    echo "==> jj is already installed ($(jj --version))"
fi

# Install neovim
if ! command -v nvim &> /dev/null; then
    echo "==> Installing neovim..."
    curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux64.tar.gz
    sudo rm -rf /opt/nvim
    sudo tar -C /opt -xzf nvim-linux64.tar.gz
    rm nvim-linux64.tar.gz
    sudo ln -sf /opt/nvim-linux64/bin/nvim /usr/local/bin/nvim
else
    echo "==> neovim is already installed ($(nvim --version | head -n1))"
fi

# Install gh CLI
if ! command -v gh &> /dev/null; then
    echo "==> Installing gh CLI..."
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
    sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
    sudo apt update
    sudo apt install gh -y
else
    echo "==> gh is already installed ($(gh --version | head -n1))"
fi

echo "==> Linux package installation complete!"
